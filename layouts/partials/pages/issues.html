{{/* Issues Page Content */}}
{{/* Support both direct context and dict with context/repoKey */}}
{{ $context := . }}
{{ $repoKey := "" }}
{{ if reflect.IsMap . }}
  {{ with .context }}{{ $context = . }}{{ end }}
  {{ with .repoKey }}{{ $repoKey = . }}{{ end }}
{{ end }}
{{ $data := partial "load-metrics.html" (dict "context" $context "repoKey" $repoKey) }}
{{ $m := $data.metrics }}
{{ $snapshots := $data.snapshots }}

{{ if not $m }}
<div class="alert alert-warning">
  <span>No data available. Run the aggregation script.</span>
</div>
{{ else }}

{{/* Extract sparkline data for issues metrics */}}
{{ $issuesOpenSparkline := partial "get-sparkline.html" (dict "snapshots" $snapshots "path" "issues.open") }}
{{ $issuesAwaitingSparkline := partial "get-sparkline.html" (dict "snapshots" $snapshots "path" "issues.without_response_24h") }}
{{ $issuesResponseMedianSparkline := partial "get-sparkline.html" (dict "snapshots" $snapshots "path" "issues.response_time.median_hours") }}
{{ $issuesStale30dSparkline := partial "get-sparkline.html" (dict "snapshots" $snapshots "path" "issues.stale_30d") }}

{{/* Calculate trends from sparkline data */}}
{{ $issuesOpenTrend := partial "calc-trend.html" (dict "sparkline" $issuesOpenSparkline) }}
{{ $issuesAwaitingTrend := partial "calc-trend.html" (dict "sparkline" $issuesAwaitingSparkline) }}
{{ $issuesResponseTrend := partial "calc-trend.html" (dict "sparkline" $issuesResponseMedianSparkline) }}
{{ $issuesStale30dTrend := partial "calc-trend.html" (dict "sparkline" $issuesStale30dSparkline) }}

{{/* Build GitHub filter URLs */}}
{{ $repoKey := $data.repoKey }}
{{ $ghBase := printf "https://github.com/%s/issues" $repoKey }}
{{ $openIssuesLink := printf "%s?q=is:issue+is:open" $ghBase }}
{{ $closed7dLink := printf "https://github.com/%s/issues?q=is:issue+is:closed+closed:>%s" $repoKey (now.AddDate 0 0 -7 | time.Format "2006-01-02") }}
{{ $closed30dLink := printf "https://github.com/%s/issues?q=is:issue+is:closed+closed:>%s" $repoKey (now.AddDate 0 0 -30 | time.Format "2006-01-02") }}
{{ $closed90dLink := printf "https://github.com/%s/issues?q=is:issue+is:closed+closed:>%s" $repoKey (now.AddDate 0 0 -90 | time.Format "2006-01-02") }}
{{ $opened7dLink := printf "https://github.com/%s/issues?q=is:issue+created:>%s" $repoKey (now.AddDate 0 0 -7 | time.Format "2006-01-02") }}
{{ $opened30dLink := printf "https://github.com/%s/issues?q=is:issue+created:>%s" $repoKey (now.AddDate 0 0 -30 | time.Format "2006-01-02") }}
{{ $opened90dLink := printf "https://github.com/%s/issues?q=is:issue+created:>%s" $repoKey (now.AddDate 0 0 -90 | time.Format "2006-01-02") }}

<!-- Volume Metrics -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-3">Volume</h2>
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
    {{ partial "metric-card.html" (dict "label" "Open Issues" "value" $m.issues.open_count "sparkline" $issuesOpenSparkline "sparklineColor" "rgb(0, 102, 204)" "trend" $issuesOpenTrend "trendGoodDirection" "down" "link" $openIssuesLink) }}
    {{ partial "metric-card.html" (dict "label" "Opened" "value" $m.issues.opened_7d "descriptor" "last 7 days" "link" $opened7dLink) }}
    {{ partial "metric-card.html" (dict "label" "Opened" "value" $m.issues.opened_30d "descriptor" "last 30 days" "link" $opened30dLink) }}
    {{ partial "metric-card.html" (dict "label" "Opened" "value" $m.issues.opened_90d "descriptor" "last 90 days" "link" $opened90dLink) }}
    {{ partial "metric-card.html" (dict "label" "Closed" "value" $m.issues.closed_7d "descriptor" "last 7 days" "link" $closed7dLink) }}
    {{ partial "metric-card.html" (dict "label" "Closed" "value" $m.issues.closed_30d "descriptor" "last 30 days" "link" $closed30dLink) }}
    {{ partial "metric-card.html" (dict "label" "Closed" "value" $m.issues.closed_90d "descriptor" "last 90 days" "link" $closed90dLink) }}
  </div>
</section>

<!-- Response Time -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-1">Response Time</h2>
  <p class="text-[10px] text-base-content/40 mb-3">Time to first maintainer response</p>
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
    {{ partial "metric-card.html" (dict "label" "Average" "value" (partial "format-hours.html" $m.issues.response_time.avg_hours)) }}
    {{ partial "metric-card.html" (dict "label" "Median" "value" (partial "format-hours.html" $m.issues.response_time.median_hours) "sparkline" $issuesResponseMedianSparkline "sparklineColor" "rgb(108, 117, 125)" "trend" $issuesResponseTrend "trendGoodDirection" "down") }}
    {{ partial "metric-card.html" (dict "label" "P90" "value" (partial "format-hours.html" $m.issues.response_time.p90_hours)) }}
    {{ partial "metric-card.html" (dict "label" "P95" "value" (partial "format-hours.html" $m.issues.response_time.p95_hours)) }}
  </div>
</section>

{{/* Links for no-response issues - using updated filter (issues with no comments, sorted by creation date) */}}
{{ $noResponse24hLink := printf "https://github.com/%s/issues?q=is:issue+is:open+comments:0+created:<=%s+sort:created-asc" $repoKey (now.AddDate 0 0 -1 | time.Format "2006-01-02") }}
{{ $noResponse7dLink := printf "https://github.com/%s/issues?q=is:issue+is:open+comments:0+created:<=%s+sort:created-asc" $repoKey (now.AddDate 0 0 -7 | time.Format "2006-01-02") }}
{{ $noResponse30dLink := printf "https://github.com/%s/issues?q=is:issue+is:open+comments:0+created:<=%s+sort:created-asc" $repoKey (now.AddDate 0 0 -30 | time.Format "2006-01-02") }}

<!-- Issues Needing Attention -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-1">Issues Needing Maintainer Attention</h2>
  <p class="text-[10px] text-base-content/40 mb-3">Open issues with no maintainer response</p>
  <div class="grid grid-cols-3 gap-3">
    {{ partial "metric-card.html" (dict "label" "No Maintainer Response" "value" $m.issues.without_response_24h "descriptor" ">24 hours" "sparkline" $issuesAwaitingSparkline "sparklineColor" "rgb(220, 53, 69)" "trend" $issuesAwaitingTrend "trendGoodDirection" "down") }}
    {{ partial "metric-card.html" (dict "label" "No Maintainer Response" "value" $m.issues.without_response_7d "descriptor" ">7 days") }}
    {{ partial "metric-card.html" (dict "label" "No Maintainer Response" "value" $m.issues.without_response_30d "descriptor" ">30 days") }}
  </div>
</section>

<!-- Issues Without Maintainer Response List -->
{{ if $m.issues.issues_without_maintainer_response }}
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-1">Issues Awaiting Maintainer Response</h2>
  <p class="text-[10px] text-base-content/40 mb-3">Sorted by longest wait time first</p>
  <div class="bg-base-100 border border-base-300 rounded-lg overflow-hidden">
    <table class="table table-xs w-full">
      <thead>
        <tr class="border-b border-base-300">
          <th class="bg-base-200/50 text-xs font-medium w-28">Issue</th>
          <th class="bg-base-200/50 text-xs font-medium">Title</th>
          <th class="bg-base-200/50 text-xs font-medium w-32">Labels</th>
          <th class="bg-base-200/50 text-xs font-medium text-right w-20">Comments</th>
          <th class="bg-base-200/50 text-xs font-medium text-right w-20">Waiting</th>
        </tr>
      </thead>
      <tbody>
        {{ range $m.issues.issues_without_maintainer_response }}
        <tr class="border-b border-base-300 last:border-b-0 hover:bg-base-200/50 cursor-pointer transition-colors group" onclick="window.open('{{ .url }}', '_blank')">
          <td class="text-xs font-mono whitespace-nowrap">
            <a href="{{ .url }}" target="_blank" class="text-primary hover:underline" onclick="event.stopPropagation()">#{{ .number }}</a>
            {{ $labels := .labels }}
            {{ $labelCount := len $labels }}
            {{ if eq $labelCount 0 }}<span class="ml-1 text-[9px] text-base-content/40">(unlabeled)</span>{{ end }}
          </td>
          <td class="text-xs max-w-md truncate" title="{{ .title }}">
            {{ .title }}
          </td>
          <td class="text-xs whitespace-nowrap">
            {{ $labels := .labels }}
            {{ $labelCount := len $labels }}
            {{ if gt $labelCount 0 }}
              {{ range first 2 $labels }}
              <span class="inline-flex items-center px-1 rounded text-[9px] border border-base-300 bg-base-200 mr-1">{{ . }}</span>
              {{ end }}
              {{ if gt $labelCount 2 }}
              <span class="inline-flex items-center px-1 rounded text-[9px] border border-base-300 bg-base-200 text-base-content/50">+{{ sub $labelCount 2 }}</span>
              {{ end }}
            {{ end }}
          </td>
          <td class="text-xs text-right">
            {{ if gt .commentCount 0 }}
            <span class="text-warning">{{ .commentCount }}</span>
            {{ else }}
            <span class="text-base-content/40">0</span>
            {{ end }}
          </td>
          <td class="text-xs text-right font-medium">
            {{ if gt .daysWaiting 30 }}
            <span class="text-error">{{ .daysWaiting }}d</span>
            {{ else if gt .daysWaiting 7 }}
            <span class="text-warning">{{ .daysWaiting }}d</span>
            {{ else }}
            {{ .daysWaiting }}d
            {{ end }}
          </td>
        </tr>
        {{ end }}
      </tbody>
    </table>
  </div>
</section>
{{ end }}

{{/* Links for stale issues - using updated filter (no activity since date) */}}
{{ $stale30dLink := printf "https://github.com/%s/issues?q=is:issue+is:open+updated:<=%s+sort:updated-asc" $repoKey (now.AddDate 0 0 -30 | time.Format "2006-01-02") }}
{{ $stale60dLink := printf "https://github.com/%s/issues?q=is:issue+is:open+updated:<=%s+sort:updated-asc" $repoKey (now.AddDate 0 0 -60 | time.Format "2006-01-02") }}
{{ $stale90dLink := printf "https://github.com/%s/issues?q=is:issue+is:open+updated:<=%s+sort:updated-asc" $repoKey (now.AddDate 0 0 -90 | time.Format "2006-01-02") }}

<!-- Stale Issues -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-1">Stale Issues</h2>
  <p class="text-[10px] text-base-content/40 mb-3">Issues with no activity</p>
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
    {{ partial "metric-card.html" (dict "label" "Stale" "value" $m.issues.stale_30d "descriptor" ">30 days" "sparkline" $issuesStale30dSparkline "sparklineColor" "rgb(255, 193, 7)" "trend" $issuesStale30dTrend "trendGoodDirection" "down" "link" $stale30dLink) }}
    {{ partial "metric-card.html" (dict "label" "Stale" "value" $m.issues.stale_60d "descriptor" ">60 days" "link" $stale60dLink) }}
    {{ partial "metric-card.html" (dict "label" "Stale" "value" $m.issues.stale_90d "descriptor" ">90 days" "link" $stale90dLink) }}
    {{ partial "metric-card.html" (dict "label" "Reopen Rate" "value" (printf "%.0f%%" (mul $m.issues.reopen_rate 100))) }}
  </div>
</section>

<!-- Label Distribution -->
{{ if $m.issues.by_label }}
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-3">Issues by Label</h2>
  <div class="bg-base-100 border border-base-300 rounded-lg overflow-hidden">
    <table class="table table-xs w-full">
      <thead>
        <tr class="border-b border-base-300">
          <th class="bg-base-200/50 text-xs font-medium">Label</th>
          <th class="bg-base-200/50 text-xs font-medium text-left w-24">Count</th>
        </tr>
      </thead>
      <tbody>
        {{/* Convert map to slice for sorting */}}
        {{ $labelSlice := slice }}
        {{ range $label, $count := $m.issues.by_label }}
          {{ $labelSlice = $labelSlice | append (dict "label" $label "count" $count) }}
        {{ end }}
        {{/* Sort by count descending */}}
        {{ range sort $labelSlice "count" "desc" }}
        {{ $labelLink := printf "https://github.com/%s/issues?q=is:issue+is:open+label:\"%s\"" $repoKey .label }}
        <tr class="border-b border-base-300 last:border-b-0 hover:bg-base-200/50 cursor-pointer transition-colors group" onclick="window.open('{{ $labelLink }}', '_blank')">
          <td class="text-xs">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] border border-base-300 bg-base-200 group-hover:border-base-content/30 transition-colors">{{ .label }}</span>
          </td>
          <td class="text-xs font-medium text-left">{{ .count }}</td>
        </tr>
        {{ end }}
      </tbody>
    </table>
  </div>
</section>
{{ end }}

{{ end }}
