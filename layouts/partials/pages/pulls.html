{{/* Pull Requests Page Content */}}
{{/* Support both direct context and dict with context/repoKey */}}
{{ $context := . }}
{{ $repoKey := "" }}
{{ if reflect.IsMap . }}
  {{ with .context }}{{ $context = . }}{{ end }}
  {{ with .repoKey }}{{ $repoKey = . }}{{ end }}
{{ end }}
{{ $data := partial "load-metrics.html" (dict "context" $context "repoKey" $repoKey) }}
{{ $m := $data.metrics }}
{{ $snapshots := $data.snapshots }}

{{ if not $m }}
<div class="alert alert-warning">
  <span>No data available. Run the aggregation script.</span>
</div>
{{ else }}

{{/* Extract sparkline data for PR metrics */}}
{{ $pullsOpenSparkline := partial "get-sparkline.html" (dict "snapshots" $snapshots "path" "pulls.open") }}
{{ $pullsAwaitingSparkline := partial "get-sparkline.html" (dict "snapshots" $snapshots "path" "pulls.without_review_24h") }}
{{ $pullsReviewMedianSparkline := partial "get-sparkline.html" (dict "snapshots" $snapshots "path" "pulls.review_time.median_hours") }}
{{ $pullsMergeMedianSparkline := partial "get-sparkline.html" (dict "snapshots" $snapshots "path" "pulls.merge_time.median_hours") }}

{{/* Calculate trends from sparkline data */}}
{{ $pullsOpenTrend := partial "calc-trend.html" (dict "sparkline" $pullsOpenSparkline) }}
{{ $pullsAwaitingTrend := partial "calc-trend.html" (dict "sparkline" $pullsAwaitingSparkline) }}
{{ $pullsReviewTrend := partial "calc-trend.html" (dict "sparkline" $pullsReviewMedianSparkline) }}
{{ $pullsMergeTrend := partial "calc-trend.html" (dict "sparkline" $pullsMergeMedianSparkline) }}

{{/* Build GitHub filter URLs for PRs */}}
{{ $repoKey := $data.repoKey }}
{{ $openPRsLink := printf "https://github.com/%s/pulls?q=is:pr+is:open" $repoKey }}
{{ $draftPRsLink := printf "https://github.com/%s/pulls?q=is:pr+is:open+draft:true" $repoKey }}
{{ $opened7dLink := printf "https://github.com/%s/pulls?q=is:pr+created:>%s" $repoKey (now.AddDate 0 0 -7 | time.Format "2006-01-02") }}
{{ $opened30dLink := printf "https://github.com/%s/pulls?q=is:pr+created:>%s" $repoKey (now.AddDate 0 0 -30 | time.Format "2006-01-02") }}
{{ $opened90dLink := printf "https://github.com/%s/pulls?q=is:pr+created:>%s" $repoKey (now.AddDate 0 0 -90 | time.Format "2006-01-02") }}
{{ $merged7dLink := printf "https://github.com/%s/pulls?q=is:pr+is:merged+merged:>%s" $repoKey (now.AddDate 0 0 -7 | time.Format "2006-01-02") }}
{{ $merged30dLink := printf "https://github.com/%s/pulls?q=is:pr+is:merged+merged:>%s" $repoKey (now.AddDate 0 0 -30 | time.Format "2006-01-02") }}
{{ $merged90dLink := printf "https://github.com/%s/pulls?q=is:pr+is:merged+merged:>%s" $repoKey (now.AddDate 0 0 -90 | time.Format "2006-01-02") }}
{{ $closedUnmerged90dLink := printf "https://github.com/%s/pulls?q=is:pr+is:closed+is:unmerged+closed:>%s" $repoKey (now.AddDate 0 0 -90 | time.Format "2006-01-02") }}

<!-- Volume Metrics -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-3">Volume</h2>
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
    {{ partial "metric-card.html" (dict "label" "Open PRs" "value" $m.pulls.open_count "sparkline" $pullsOpenSparkline "sparklineColor" "rgb(40, 167, 69)" "trend" $pullsOpenTrend "trendGoodDirection" "down" "link" $openPRsLink) }}
    {{ partial "metric-card.html" (dict "label" "Draft PRs" "value" $m.pulls.draft_count "link" $draftPRsLink) }}
    {{ partial "metric-card.html" (dict "label" "Opened" "value" $m.pulls.opened_7d "descriptor" "last 7 days" "link" $opened7dLink) }}
    {{ partial "metric-card.html" (dict "label" "Opened" "value" $m.pulls.opened_30d "descriptor" "last 30 days" "link" $opened30dLink) }}
    {{ partial "metric-card.html" (dict "label" "Opened" "value" $m.pulls.opened_90d "descriptor" "last 90 days" "link" $opened90dLink) }}
    {{ partial "metric-card.html" (dict "label" "Merged" "value" $m.pulls.merged_7d "descriptor" "last 7 days" "link" $merged7dLink) }}
    {{ partial "metric-card.html" (dict "label" "Merged" "value" $m.pulls.merged_30d "descriptor" "last 30 days" "link" $merged30dLink) }}
    {{ partial "metric-card.html" (dict "label" "Merged" "value" $m.pulls.merged_90d "descriptor" "last 90 days" "link" $merged90dLink) }}
    {{ partial "metric-card.html" (dict "label" "Closed Unmerged" "value" $m.pulls.closed_not_merged_90d "descriptor" "last 90 days" "link" $closedUnmerged90dLink) }}
  </div>
</section>

<!-- Review Time -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-3">Time to First Review</h2>
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
    {{ partial "metric-card.html" (dict "label" "Average" "value" (partial "format-hours.html" $m.pulls.review_time.avg_hours)) }}
    {{ partial "metric-card.html" (dict "label" "Median" "value" (partial "format-hours.html" $m.pulls.review_time.median_hours) "sparkline" $pullsReviewMedianSparkline "sparklineColor" "rgb(108, 117, 125)" "trend" $pullsReviewTrend "trendGoodDirection" "down") }}
    {{ partial "metric-card.html" (dict "label" "P90" "value" (partial "format-hours.html" $m.pulls.review_time.p90_hours)) }}
    {{ partial "metric-card.html" (dict "label" "P95" "value" (partial "format-hours.html" $m.pulls.review_time.p95_hours)) }}
  </div>
</section>

<!-- Merge Time -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-3">Merge Time</h2>
  <div class="grid grid-cols-2 gap-3">
    {{ partial "metric-card.html" (dict "label" "Average" "value" (partial "format-hours.html" $m.pulls.merge_time.avg_hours)) }}
    {{ partial "metric-card.html" (dict "label" "Median" "value" (partial "format-hours.html" $m.pulls.merge_time.median_hours) "sparkline" $pullsMergeMedianSparkline "sparklineColor" "rgb(108, 117, 125)" "trend" $pullsMergeTrend "trendGoodDirection" "down") }}
  </div>
</section>

{{/* Links for PRs needing review - using review:none filter */}}
{{ $noReview24hLink := printf "https://github.com/%s/pulls?q=is:pr+is:open+review:none+created:<=%s+sort:created-asc" $repoKey (now.AddDate 0 0 -1 | time.Format "2006-01-02") }}
{{ $noReview7dLink := printf "https://github.com/%s/pulls?q=is:pr+is:open+review:none+created:<=%s+sort:created-asc" $repoKey (now.AddDate 0 0 -7 | time.Format "2006-01-02") }}

<!-- PRs Needing Attention -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-1">PRs Needing Maintainer Review</h2>
  <p class="text-[10px] text-base-content/40 mb-3">Open PRs with no maintainer review (excludes drafts from counts)</p>
  <div class="grid grid-cols-2 gap-3">
    {{ partial "metric-card.html" (dict "label" "No Maintainer Review" "value" $m.pulls.without_review_24h "descriptor" ">24 hours" "sparkline" $pullsAwaitingSparkline "sparklineColor" "rgb(220, 53, 69)" "trend" $pullsAwaitingTrend "trendGoodDirection" "down") }}
    {{ partial "metric-card.html" (dict "label" "No Maintainer Review" "value" $m.pulls.without_review_7d "descriptor" ">7 days") }}
  </div>
</section>

<!-- PRs Without Maintainer Review List -->
{{ if $m.pulls.prs_without_maintainer_review }}
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-1">PRs Awaiting Maintainer Review</h2>
  <p class="text-[10px] text-base-content/40 mb-3">Sorted by longest wait time first</p>
  <div class="bg-base-100 border border-base-300 rounded-lg overflow-hidden">
    <table class="table table-xs w-full">
      <thead>
        <tr class="border-b border-base-300">
          <th class="bg-base-200/50 text-xs font-medium w-28">PR</th>
          <th class="bg-base-200/50 text-xs font-medium">Title</th>
          <th class="bg-base-200/50 text-xs font-medium w-24">Author</th>
          <th class="bg-base-200/50 text-xs font-medium text-right w-20">Size</th>
          <th class="bg-base-200/50 text-xs font-medium text-right w-20">Reviews</th>
          <th class="bg-base-200/50 text-xs font-medium text-right w-20">Waiting</th>
        </tr>
      </thead>
      <tbody>
        {{ range $m.pulls.prs_without_maintainer_review }}
        <tr class="border-b border-base-300 last:border-b-0 hover:bg-base-200/50 cursor-pointer transition-colors group {{ if .isDraft }}opacity-50{{ end }}" onclick="window.open('{{ .url }}', '_blank')">
          <td class="text-xs font-mono whitespace-nowrap">
            <a href="{{ .url }}" target="_blank" class="text-primary hover:underline" onclick="event.stopPropagation()">#{{ .number }}</a>
            {{ if .isDraft }}<span class="ml-1 text-[9px] text-base-content/40">(draft)</span>{{ end }}
          </td>
          <td class="text-xs max-w-md truncate" title="{{ .title }}">
            {{ .title }}
          </td>
          <td class="text-xs text-base-content/70">
            {{ if .author }}{{ .author }}{{ else }}<span class="italic">unknown</span>{{ end }}
          </td>
          <td class="text-xs text-right">
            <span class="text-success">+{{ .additions }}</span>
            <span class="text-error">-{{ .deletions }}</span>
          </td>
          <td class="text-xs text-right">
            {{ if gt .reviewCount 0 }}
            <span class="text-warning">{{ .reviewCount }}</span>
            {{ else }}
            <span class="text-base-content/40">0</span>
            {{ end }}
          </td>
          <td class="text-xs text-right font-medium">
            {{ if .isDraft }}
            <span class="text-base-content/40">{{ .daysWaiting }}d</span>
            {{ else if gt .daysWaiting 7 }}
            <span class="text-error">{{ .daysWaiting }}d</span>
            {{ else if gt .daysWaiting 1 }}
            <span class="text-warning">{{ .daysWaiting }}d</span>
            {{ else }}
            {{ .daysWaiting }}d
            {{ end }}
          </td>
        </tr>
        {{ end }}
      </tbody>
    </table>
  </div>
</section>
{{ end }}

<!-- Size Distribution -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-1">PR Size Distribution</h2>
  <p class="text-[10px] text-base-content/40 mb-3">Open PRs by lines changed</p>
  <div class="grid grid-cols-3 gap-3">
    {{ partial "metric-card.html" (dict "label" "Small" "value" $m.pulls.by_size.small "descriptor" "<100 lines") }}
    {{ partial "metric-card.html" (dict "label" "Medium" "value" $m.pulls.by_size.medium "descriptor" "100-500 lines") }}
    {{ partial "metric-card.html" (dict "label" "Large" "value" $m.pulls.by_size.large "descriptor" ">500 lines") }}
  </div>
</section>

{{ end }}
