{{/* Pull Requests Page Content */}}
{{/* Support both direct context and dict with context/repoKey */}}
{{ $context := . }}
{{ $repoKey := "" }}
{{ if reflect.IsMap . }}
  {{ with .context }}{{ $context = . }}{{ end }}
  {{ with .repoKey }}{{ $repoKey = . }}{{ end }}
{{ end }}
{{ $data := partial "load-metrics.html" (dict "context" $context "repoKey" $repoKey) }}
{{ $m := $data.metrics }}

{{ if not $m }}
<div class="alert alert-warning">
  <span>No data available. Run the aggregation script.</span>
</div>
{{ else }}

<!-- Volume Metrics -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-3">Volume</h2>
  <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
    {{ partial "metric-card.html" (dict "label" "Open PRs" "value" $m.pulls.open_count) }}
    {{ partial "metric-card.html" (dict "label" "Draft PRs" "value" $m.pulls.draft_count) }}
    {{ partial "metric-card.html" (dict "label" "Merged" "value" $m.pulls.merged_7d "descriptor" "last 7 days") }}
    {{ partial "metric-card.html" (dict "label" "Merged" "value" $m.pulls.merged_30d "descriptor" "last 30 days") }}
    {{ partial "metric-card.html" (dict "label" "Merged" "value" $m.pulls.merged_90d "descriptor" "last 90 days") }}
    {{ partial "metric-card.html" (dict "label" "Closed Unmerged" "value" $m.pulls.closed_not_merged_90d "descriptor" "last 90 days") }}
  </div>
</section>

<!-- Review Time -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-3">Time to First Review</h2>
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
    {{ partial "metric-card.html" (dict "label" "Average" "value" (partial "format-hours.html" $m.pulls.review_time.avg_hours)) }}
    {{ partial "metric-card.html" (dict "label" "Median" "value" (partial "format-hours.html" $m.pulls.review_time.median_hours)) }}
    {{ partial "metric-card.html" (dict "label" "P90" "value" (partial "format-hours.html" $m.pulls.review_time.p90_hours)) }}
    {{ partial "metric-card.html" (dict "label" "P95" "value" (partial "format-hours.html" $m.pulls.review_time.p95_hours)) }}
  </div>
</section>

<!-- Merge Time -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-3">Merge Time</h2>
  <div class="grid grid-cols-2 gap-3">
    {{ partial "metric-card.html" (dict "label" "Average" "value" (partial "format-hours.html" $m.pulls.merge_time.avg_hours)) }}
    {{ partial "metric-card.html" (dict "label" "Median" "value" (partial "format-hours.html" $m.pulls.merge_time.median_hours)) }}
  </div>
</section>

<!-- PRs Needing Attention -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-3">PRs Needing Attention</h2>
  <div class="grid grid-cols-2 gap-3">
    {{ partial "metric-card.html" (dict "label" "No Review" "value" $m.pulls.without_review_24h "descriptor" ">24 hours") }}
    {{ partial "metric-card.html" (dict "label" "No Review" "value" $m.pulls.without_review_7d "descriptor" ">7 days") }}
  </div>
</section>

<!-- Size Distribution -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-1">PR Size Distribution</h2>
  <p class="text-[10px] text-base-content/40 mb-3">Open PRs by lines changed</p>
  <div class="grid grid-cols-3 gap-3">
    {{ partial "metric-card.html" (dict "label" "Small" "value" $m.pulls.by_size.small "descriptor" "<100 lines") }}
    {{ partial "metric-card.html" (dict "label" "Medium" "value" $m.pulls.by_size.medium "descriptor" "100-500 lines") }}
    {{ partial "metric-card.html" (dict "label" "Large" "value" $m.pulls.by_size.large "descriptor" ">500 lines") }}
  </div>
</section>

{{ end }}
