{{/* Health & Trends Page Content */}}
{{/* Support both direct context and dict with context/repoKey */}}
{{ $context := . }}
{{ $repoKey := "" }}
{{ if reflect.IsMap . }}
  {{ with .context }}{{ $context = . }}{{ end }}
  {{ with .repoKey }}{{ $repoKey = . }}{{ end }}
{{ end }}
{{ $data := partial "load-metrics.html" (dict "context" $context "repoKey" $repoKey) }}
{{ $m := $data.metrics }}
{{ $snapshots := $data.snapshots }}

{{ if not $m }}
<div class="alert alert-warning">
  <span>No data available. Run the aggregation script.</span>
</div>
{{ else }}

<!-- Hotspots -->
{{ if $m.hotspots }}
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-1">Code Hotspots</h2>
  <p class="text-[10px] text-base-content/40 mb-3">Files most frequently modified in merged PRs (last 90 days)</p>

  {{ if $m.hotspots.by_file }}
  <div class="mb-4">
    <h3 class="text-xs font-medium text-base-content/70 mb-2">Top Files</h3>
    <div class="overflow-x-auto rounded-lg border border-base-300 bg-base-100">
      <table class="table table-sm table-bordered table-fixed w-full">
        <thead>
          <tr>
            <th class="bg-base-200 w-1/2">File</th>
            <th class="bg-base-200 w-1/4">PRs</th>
            <th class="bg-base-200 w-1/4">Total Changes</th>
          </tr>
        </thead>
        <tbody>
          {{ range $m.hotspots.by_file }}
          <tr>
            <td><code class="text-xs break-all">{{ .path }}</code></td>
            <td>{{ .pr_count }}</td>
            <td>{{ .total_changes }}</td>
          </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
  </div>
  {{ end }}

  {{ if $m.hotspots.by_directory }}
  <div>
    <h3 class="text-xs font-medium text-base-content/70 mb-2">Top Directories</h3>
    <div class="overflow-x-auto rounded-lg border border-base-300 bg-base-100">
      <table class="table table-sm table-bordered table-fixed w-full">
        <thead>
          <tr>
            <th class="bg-base-200 w-1/2">Directory</th>
            <th class="bg-base-200 w-1/4">PRs</th>
            <th class="bg-base-200 w-1/4">Files Touched</th>
          </tr>
        </thead>
        <tbody>
          {{ range $m.hotspots.by_directory }}
          <tr>
            <td><code class="text-xs break-all">{{ .path }}</code></td>
            <td>{{ .pr_count }}</td>
            <td>{{ .file_count }}</td>
          </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
  </div>
  {{ end }}
</section>
{{ end }}

<!-- Historical Trends -->
<section class="mb-6">
  <h2 class="text-sm font-semibold mb-3">Historical Trends</h2>
  {{ if $snapshots }}
    {{/* Collect snapshots into a sortable slice */}}
    {{ $entries := slice }}
    {{ range $filename, $data := $snapshots }}
      {{ $entries = $entries | append (dict "date" $data.date "issues_open" $data.issues.open "pulls_open" $data.pulls.open "stars" $data.repository.stars) }}
    {{ end }}

    {{/* Sort by date ascending */}}
    {{ $sorted := sort $entries "date" "asc" }}

    {{/* Extract sorted arrays */}}
    {{ $dates := slice }}
    {{ $issuesOpen := slice }}
    {{ $pullsOpen := slice }}
    {{ $stars := slice }}
    {{ range $sorted }}
      {{ $dates = $dates | append .date }}
      {{ $issuesOpen = $issuesOpen | append .issues_open }}
      {{ $pullsOpen = $pullsOpen | append .pulls_open }}
      {{ $stars = $stars | append .stars }}
    {{ end }}

    {{ if gt (len $dates) 1 }}
    <div class="space-y-4">
      <div class="bg-base-100 border border-base-300 rounded-lg p-4">
        <h3 class="text-xs font-medium text-base-content/70 mb-3">Open Issues Over Time</h3>
        <canvas data-chart='{
          "type": "line",
          "data": {
            "labels": {{ $dates | jsonify }},
            "datasets": [{
              "label": "Open Issues",
              "data": {{ $issuesOpen | jsonify }},
              "borderColor": "rgb(0, 102, 204)",
              "backgroundColor": "rgba(0, 102, 204, 0.1)",
              "fill": true,
              "tension": 0.3
            }]
          },
          "options": {
            "responsive": true,
            "plugins": { "legend": { "display": false } }
          }
        }'></canvas>
      </div>

      <div class="bg-base-100 border border-base-300 rounded-lg p-4">
        <h3 class="text-xs font-medium text-base-content/70 mb-3">Open PRs Over Time</h3>
        <canvas data-chart='{
          "type": "line",
          "data": {
            "labels": {{ $dates | jsonify }},
            "datasets": [{
              "label": "Open PRs",
              "data": {{ $pullsOpen | jsonify }},
              "borderColor": "rgb(40, 167, 69)",
              "backgroundColor": "rgba(40, 167, 69, 0.1)",
              "fill": true,
              "tension": 0.3
            }]
          },
          "options": {
            "responsive": true,
            "plugins": { "legend": { "display": false } }
          }
        }'></canvas>
      </div>

      <div class="bg-base-100 border border-base-300 rounded-lg p-4">
        <h3 class="text-xs font-medium text-base-content/70 mb-3">Stars Over Time</h3>
        <canvas data-chart='{
          "type": "line",
          "data": {
            "labels": {{ $dates | jsonify }},
            "datasets": [{
              "label": "Stars",
              "data": {{ $stars | jsonify }},
              "borderColor": "rgb(255, 193, 7)",
              "backgroundColor": "rgba(255, 193, 7, 0.1)",
              "fill": true,
              "tension": 0.3
            }]
          },
          "options": {
            "responsive": true,
            "plugins": { "legend": { "display": false } }
          }
        }'></canvas>
      </div>
    </div>
    {{ else }}
    <div class="bg-base-100 border border-base-300 rounded-lg p-4 text-sm text-base-content/70">
      Not enough historical data yet. Trends will appear after multiple data syncs.
    </div>
    {{ end }}
  {{ else }}
  <div class="bg-base-100 border border-base-300 rounded-lg p-4 text-sm text-base-content/70">
    No snapshot data available yet. Trends will appear after daily snapshots accumulate.
  </div>
  {{ end }}
</section>

{{ end }}
